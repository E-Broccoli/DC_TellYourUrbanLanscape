
<div class="row">
  <!-- Success and Error Messages for the user -->
  <div class="col-md-12">
    <!-- Success alert box -->
    <div id="success" class="alert alert-success" style="display:none;">
      <a class="close">×</a><strong>Well done!</strong> Your answer has been saved
    </div>
    <!-- Task completed alert box -->
    <div id="taskcompleted" class="alert alert-info" style="display:none;">
      <strong>The task has been completed!</strong> Thanks a lot!
    </div>
    <!-- Task loading alert box -->
    <div id="loadingTask" class="alert alert-info">
      <strong>Loading task...</strong>
    </div>
    <!-- Task completed alert box -->
    <div id="finish" class="alert alert-success" style="display:none;">
      <strong>Congratulations!</strong> You have participated in all available tasks!
      <br/>
      <div class="alert-actions">
        <a class="btn small" href="/">Go back</a>
        <a class="btn small" href="/app">or, Check other projects</a>
      </div>
    </div>
    <!-- Error alert box -->
    <div id="error" class="alert alert-danger" style="display:none;">
      <a class="close">×</a>
      <strong>Error!</strong> Something went wrong, please contact the site administrators
    </div>
    <!-- Old Browser alert box -->
    <div id="oldBrowser" class="alert alert-info" style="display:none;">
      <a class="close">×</a>
      <p><strong>Sorry!</strong> Your web browser does not support the application.<p>
        <div class="alert-actions">
          <a class="btn small" href="/app">Please, try with another project</a>
        </div>
      </div>
    </div><!-- End of span8 col-md-offset-2-->
  </div><!-- End of Row-->

  <div class="row">
    <div class="skeleton col-md-12">
      <h1 class="lead" id="question"></h1>
      <h2 class="lead display-5 text-success">Mark the place of your memory in the New Waverley area, north Canongate, Edinburgh </h2>
      <div>

        <div id="map" class="mb-3"></div>
        <p class="text-info"><i class="fa fa-map-marker"></i> Memory place position
          <span id="lat"></span> <span id="lon"></span>
        </p>



      </div>
      <form id="magicData" role="form">
        <div class="row">
          <div class="skeleton col-md-12">

            <div class="form-group">
              <h3 class="lead">Memory Box</h3>
              <p>
                <textarea class="form-control" rows="5" id="memory" name="memory"
                placeholder="Tell us your story"></textarea>
              </p>
            </div>
          </div>
        </div>
        <div id="answer">
          <button id="answerbtn" class="btn btn-success btn-submit btn-answer">
            <i class="fa fa-check"></i> Save the place and your memories
          </button>
        </div>
      </form>
    </div>
    <!-- The data entry section using html table -->
    <div class="col-md-12 my-3">

      <!-- Feedback items for the user -->
      <p>
        You are working now on task: <span id="taskid" class="badge badge-warning badge-lg">#</span>
      </p>
      <p>
        You have completed: <span id="done" class="badge badge-info"></span> tasks from
        <!-- Progress bar for the user -->
        <span id="total" class="badge badge-dark"></span>
      </p>
      <div class="progress progress-striped">
        <div id="progress" rel="tooltip" title="#" class="progress-bar" role="progressbar"
        style="width: 0%;"></div>
      </div>
      <!-- End of feedback row -->
    </div>
    <!-- End of the section -->
  </div>
  <style media="screen">
    #map { height: 400px; width:100%;}
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
  crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
  integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
  crossorigin=""></script>
  <!-- PyBossa interface -->


  <script>
    var map = L.map('map',{dragging:false, scrollWheelZoom:false}).setView([55.951957, -3.181014], 17);
    L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
   }).addTo(map);
    var onClick = function(e) {
      map.off('click', onClick);
      var marker = L.marker(e.latlng,{draggable: true}).addTo(map);
      var lat = e.latlng.lat;
      var lon = e.latlng.lng;
      $('#lat').html('').append(' Latitude: ' + lat + ',');
      $('#lon').html('').append(' Longitude: ' + lon);
      console.log("Lat, Lon : " + lat + ", " + lon);
    };
    map.on('click', onClick);
  </script>

  <script>
    // This part of the script loads the user's progress through the project

    function loadUserProgress() {
      pybossa.userProgress('Urblan').done(function(data) {
        console.log(data);
        console.log("Total answers done for user: " + data.done);
        var pct = Math.round((data.done * 100) / data.total);
        $("#progress").css("width", pct.toString() + "%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({ 'placement' : 'left' });
        $("#total").text(data.total);
        $("#done").text(data.done);
        $('a[rel]').tooltip({'placement' : 'left'});
      });
    }

    pybossa.taskLoaded(function(task, deferred) {
      if (! $.isEmptyObject(task)) {
        $('#loadingTask').hide();
        loadUserProgress();
        deferred.resolve(task);
      } else {
        deferred.resolve(task);
      }
    });

    // This part presents the task and then saves the answers

    pybossa.presentTask(function(task, deferred) {
      if (!$.isEmptyObject(task)) {
        console.log(task)
        $('#question').html(task.info.question);
        $('#taskid').html(task.id);
        $('#city').html('').append(task.info.city);

        $('#btnanswer').off('click').on('click', function(evt) {
          evt.preventDefault();
          var answer = $(evt.target).attr("value");
          console.log(answer)
          if ( typeof answer != 'undefined') {
            task.answer = $("#magicData").serializeJSON();
            task.answer.lat = lat;
            task.answer.lon = lon;
            task.answer.coords = lon + ',' + lat;
            task.answer.memory = memory;
            console.log(task.answer);
            pybossa.saveTask(task.id, task.answer).done(function() {
              $("html, body").animate( {scrollTop : 0 }, "slow");
              $("#success").fadeIn(500).fadeOut(500);
              $("#loading").fadeIn(500).fadeOut(500);
              $('#magicData')[0].reset();
              deferred.resolve();
            });
          } else {
            $("#error").show();
          }
        });
        $("#loading").hide();
      } else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
      }
    });
    pybossa.run('Urblan');
  </script>
